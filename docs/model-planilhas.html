<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modal de Edição de Planilha (Excel-like)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilos gerais */
        body {
            font-family: Arial, sans-serif;
            background-color: #1e222a; /* Cor de fundo principal */
            color: #cbd5e1;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Botão na Área de Trabalho */
        .desktop-button-container {
            display: flex;
            justify-content: center;
            padding: 20px;
            background-color: #2c3037; /* Fundo cinza escuro para o container do botão */
            width: 100%;
            box-sizing: border-box;
        }

        .desktop-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .desktop-button:hover {
            background-color: #2563eb;
        }

        /* Estilos base para o Modal */
        .modal-overlay {
            display: none; /* Escondido por padrão */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #2c3037;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            padding: 20px;
            box-sizing: border-box;
            max-height: 90vh;
            overflow: hidden; /* Controlado por seções internas */
            color: #cbd5e1;
            transform: translate(-50%, -50%); /* Centraliza o modal */
            top: 50%;
            left: 50%;
            position: absolute;
            width: 90%; /* Largura padrão */
            max-width: 900px; /* Largura máxima */
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.3s ease; /* Transição para maximizar/restaurar */
        }

        .modal-content.maximized {
            width: 98%;
            max-width: 98%;
            height: 98%;
            max-height: 98%;
            border-radius: 0;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .modal-close-button, .modal-maximize-button {
            position: absolute;
            top: 10px;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s ease;
            z-index: 1020;
        }
        .modal-close-button:hover, .modal-maximize-button:hover {
            color: white;
        }
        .modal-close-button { right: 15px; }
        .modal-maximize-button { right: 45px; }


        /* Campos de input, textarea e select */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            background-color: #1e222a;
            border: 1px solid #3f4757;
            color: #cbd5e1;
            padding: 8px;
            border-radius: 4px;
            width: calc(100% - 18px); /* Para compensar o padding e borda */
            box-sizing: border-box;
            margin-bottom: 0; /* Ajustado para layout de planilha */
            font-size: 14px;
        }
        input[type="checkbox"] {
            transform: scale(1.1);
            margin: 0;
            accent-color: #3b82f6; /* Cor do checkbox */
        }
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 32px;
            height: 32px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 4px;
        }
        input[type="color"]::-webkit-color-swatch {
            border-radius: 4px;
            border: 1px solid #3f4757;
        }
        input[type="color"]::-moz-color-swatch {
            border-radius: 4px;
            border: 1px solid #3f4757;
        }

        /* Botões de ação */
        .modal-button {
            background-color: #374151;
            color: #cbd5e1;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .modal-button.primary {
            background-color: #2563eb;
            color: white;
        }

        .modal-button.text-only {
            background: none;
            color: #94a3b8;
            padding: 8px 0;
        }

        .modal-button.danger {
            background-color: #dc2626;
        }

        .modal-button:hover:not(.text-only) {
            background-color: #475569;
        }

        .modal-button.primary:hover {
            background-color: #1e40af;
        }

        .modal-button.danger:hover {
            background-color: #b91c1c;
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* Para rolagem horizontal */
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }

        /* Título do modal */
        .modal-title-input {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 0;
            border: none;
            background-color: transparent;
            color: #cbd5e1;
            padding: 5px;
            width: calc(100% - 10px);
        }
        .modal-title-input:focus {
            outline: 1px solid #3b82f6;
            border-radius: 4px;
        }

        /* Layout principal do modal com sidebar */
        .modal-sheet-layout {
            display: flex;
            gap: 20px;
            flex-grow: 1; /* Permite que o layout ocupe o espaço restante */
            overflow: hidden; /* Garante que scrollbars internas funcionem */
        }

        .modal-sidebar {
            width: 180px; /* Largura fixa para a sidebar */
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0; /* Não encolhe */
            padding-top: 5px; /* Alinha com o conteúdo principal */
        }
        .modal-sidebar .modal-button {
            width: 100%;
            justify-content: flex-start;
            text-align: left;
        }
        .modal-sidebar .section-title {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 16px;
        }

        /* --- Barra de Ferramentas da Planilha --- */
        .sheet-toolbar {
            background-color: #1e222a;
            border: 1px solid #3f4757;
            border-radius: 4px;
            padding: 8px 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0; /* Não encolhe para manter os botões visíveis */
        }
        .sheet-toolbar .modal-button {
            padding: 6px 10px;
            font-size: 13px;
        }
        .sheet-toolbar select {
            width: auto; /* Permite que o select se ajuste ao conteúdo */
            min-width: 80px;
            margin-bottom: 0;
            font-size: 13px;
            padding: 6px 8px;
        }
        .sheet-toolbar .separator {
            width: 1px;
            background-color: #3f4757;
            height: 24px;
            margin: 0 5px;
        }
        .sheet-toolbar label {
            font-size: 13px;
            color: #94a3b8;
        }


        /* --- Tabela da Planilha --- */
        .sheet-table-container {
            flex-grow: 1; /* Permite que o container da tabela ocupe o espaço restante */
            overflow: auto; /* Adiciona scrollbars quando necessário */
            background-color: #1e222a;
            border: 1px solid #3f4757;
            border-radius: 4px;
            position: relative; /* Para o popover */
            user-select: none; /* Desabilita seleção de texto padrão */
        }

        .sheet-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Colunas com largura fixa */
            min-width: 600px; /* Largura mínima para evitar quebras */
            user-select: none; /* Desabilita seleção de texto padrão */
        }

        .sheet-table th,
        .sheet-table td {
            border: 1px solid #3f4757;
            padding: 0; /* Padding será interno ao input/select */
            text-align: left;
            vertical-align: top; /* Alinha no topo para quebra de linha */
            position: relative; /* Para o popover e redimensionadores */
            height: 38px; /* Altura padrão da célula */
            box-sizing: border-box;
            user-select: none; /* Desabilita seleção de texto padrão */
        }

        .sheet-table th {
            background-color: #374151;
            color: #cbd5e1;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            padding: 8px; /* Padding no cabeçalho */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            user-select: none; /* Evita seleção de texto ao arrastar */
        }
        .sheet-table th.active {
            outline: 2px solid #3b82f6; /* Destaque para coluna ativa */
        }

        .sheet-table td {
            background-color: #1e222a;
            user-select: none; /* Desabilita seleção de texto padrão */
        }

        .sheet-table td input,
        .sheet-table td select,
        .sheet-table td .cell-content { /* .cell-content para checkboxes e links */
            width: 100%;
            height: 100%;
            border: none;
            background-color: transparent;
            color: #cbd5e1;
            padding: 8px; /* Padding interno para o conteúdo da célula */
            box-sizing: border-box;
            outline: none;
            font-size: 14px;
            display: flex; /* Para centralizar conteúdo se precisar */
            align-items: flex-start; /* Alinha no topo para quebra de linha */
            justify-content: flex-start; /* Alinha à esquerda por padrão */
            white-space: nowrap; /* Padrão: sem quebra de linha */
            overflow: hidden; /* Esconde conteúdo extra */
            text-overflow: ellipsis; /* Adiciona reticências */
            user-select: text; /* Permite seleção de texto dentro do input */
            resize: none; /* Desabilita redimensionamento manual de textarea */
        }
        /* Estilos para células com quebra de linha ativada */
        .sheet-table td.wrap-text input,
        .sheet-table td.wrap-text .cell-content {
            white-space: normal; /* Ativa quebra de linha */
            overflow: auto; /* Permite rolagem dentro da célula se necessário */
            text-overflow: clip; /* Remove reticências */
        }
        .sheet-table td.wrap-text {
            height: auto !important; /* Altura automática para quebra de linha */
        }


        .sheet-table td input:focus,
        .sheet-table td select:focus,
        .sheet-table td .cell-content.focus {
            background-color: #3f4757; /* Fundo mais escuro ao focar */
        }
        .sheet-table td.active {
            outline: 2px solid #3b82f6; /* Destaque para célula ativa */
            background-color: #3f4757;
        }
        .sheet-table td.selected {
            background-color: #4a5a70; /* Cor de fundo para células selecionadas */
        }
        .sheet-table td input[type="checkbox"] {
            width: auto; /* Checkbox não ocupa 100% da largura */
            height: auto;
            margin: auto; /* Centraliza o checkbox verticalmente */
        }

        /* Resizers */
        .column-resizer, .row-resizer {
            position: absolute;
            background-color: transparent; /* Transparente por padrão */
            transition: background-color 0.2s ease;
            z-index: 10;
        }
        .column-resizer {
            top: 0;
            right: -4px; /* Metade da largura do resizer */
            width: 8px;
            height: 100%;
            cursor: col-resize;
        }
        .row-resizer {
            left: 0;
            bottom: -4px; /* Metade da altura do resizer */
            height: 8px;
            width: 100%;
            cursor: row-resize;
        }
        /* Estilos ao passar o mouse ou redimensionar */
        .column-resizer:hover, .column-resizer.active,
        .row-resizer:hover, .row-resizer.active {
            background-color: #3b82f6; /* Cor visível ao interagir */
        }
        .sheet-table th.resizing, .sheet-table tr.resizing {
            background-color: #4b5563; /* Fundo enquanto redimensiona */
        }


        /* Botões de ação de linha/coluna */
        .sheet-table .remove-col-button,
        .sheet-table .remove-row-button {
            position: absolute;
            top: 2px;
            right: 2px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            line-height: 1;
            opacity: 0; /* Escondido por padrão */
            transition: opacity 0.2s ease, color 0.2s ease;
            z-index: 11; /* Acima do resizer */
        }
        .sheet-table th:hover .remove-col-button,
        .sheet-table tr:hover .remove-row-button {
            opacity: 1; /* Visível ao passar o mouse */
        }
        .sheet-table .remove-col-button:hover,
        .sheet-table .remove-row-button:hover {
            color: #ff5252;
        }


        /* Popover de edição de coluna */
        .column-edit-popover {
            position: absolute;
            background-color: #374151;
            border: 1px solid #3f4757;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            z-index: 1010;
            display: none; /* Escondido por padrão */
            flex-direction: column;
            gap: 10px;
            width: 220px;
            left: 50%;
            transform: translateX(-50%);
            top: calc(100% + 5px); /* Abaixo do cabeçalho */
        }
        .column-edit-popover::before { /* Seta para cima */
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 14px;
            height: 14px;
            background-color: #374151;
            border-top: 1px solid #3f4757;
            border-left: 1px solid #3f4757;
        }
        .column-edit-popover label {
            font-size: 13px;
            color: #cbd5e1;
            margin-bottom: -5px;
            display: block;
        }
        .column-edit-popover input,
        .column-edit-popover select {
            width: 100%;
            margin-bottom: 0;
            padding: 6px;
            font-size: 13px;
        }
        .column-edit-popover .popover-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 5px;
        }
        .column-edit-popover .popover-actions .modal-button {
            padding: 6px 10px;
            font-size: 13px;
        }

        /* --- Menu de Contexto (Botão Direito) --- */
        .context-menu {
            display: none;
            position: fixed;
            background-color: #374151;
            border: 1px solid #3f4757;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1050;
            min-width: 150px;
            padding: 5px 0;
        }
        .context-menu-item {
            padding: 8px 15px;
            color: #cbd5e1;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .context-menu-item:hover {
            background-color: #475569;
        }
        .context-menu-item.disabled {
            color: #64748b;
            cursor: not-allowed;
        }
        .context-menu-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            display: none;
            background-color: #374151;
            border: 1px solid #3f4757;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            min-width: 150px;
            padding: 5px 0;
        }
        .context-menu-item.has-submenu:hover > .context-menu-submenu {
            display: block;
        }


        /* --- Ações Inferiores --- */
        .bottom-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start;
            margin-top: auto; /* Empurra para o final do modal */
            flex-shrink: 0; /* Não encolhe */
        }

        /* Tooltip */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Posição acima do elemento */
            left: 50%;
            transform: translateX(-50%); /* Centraliza o tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            font-size: 12px;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95%;
                padding: 15px;
            }

            .modal-sheet-layout {
                flex-direction: column; /* Empilha o conteúdo e a sidebar */
            }

            .modal-sidebar {
                width: 100%; /* Sidebar ocupa a largura total */
                max-width: none;
                order: 2; /* Move a sidebar para baixo */
            }

            .modal-sheet-main {
                order: 1; /* Conteúdo principal fica em cima */
            }

            .sheet-table-container {
                overflow-x: auto; /* Adiciona rolagem horizontal à tabela */
            }
            .sheet-table {
                min-width: 600px; /* Garante que a tabela tenha uma largura mínima para rolar */
            }

            .desktop-button {
                width: 90%; /* Botão ocupa mais espaço */
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                padding: 10px;
            }

            .modal-close-button, .modal-maximize-button {
                font-size: 18px;
                right: 8px;
                top: 8px;
            }
            .modal-maximize-button { right: 35px; }


            .modal-title-input {
                font-size: 18px;
            }

            .modal-button {
                font-size: 13px;
                padding: 6px 10px;
            }

            .sheet-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .sheet-toolbar select, .sheet-toolbar input {
                width: 100%;
            }

            .sheet-table th, .sheet-table td {
                font-size: 13px;
            }

            .bottom-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>

    <div class="desktop-button-container">
        <button class="desktop-button" onclick="openSheetModal()">Ver Modal de Edição de Planilha</button>
    </div>

    <div id="sheetModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-maximize-button" onclick="toggleMaximizeModal()">
                <i class="far fa-window-maximize"></i>
            </button>
            <button class="modal-close-button" onclick="closeSheetModal()">&times;</button>

            <input type="text" value="Planilha de Tarefas" class="modal-title-input">

            <div class="sheet-toolbar">
                <button class="modal-button" id="boldBtn"><i class="fas fa-bold"></i></button>
                <button class="modal-button" id="italicBtn"><i class="fas fa-italic"></i></button>
                <button class="modal-button" id="underlineBtn"><i class="fas fa-underline"></i></button>
                <div class="separator"></div>
                <button class="modal-button" id="alignLeftBtn"><i class="fas fa-align-left"></i></button>
                <button class="modal-button" id="alignCenterBtn"><i class="fas fa-align-center"></i></button>
                <button class="modal-button" id="alignRightBtn"><i class="fas fa-align-right"></i></button>
                <div class="separator"></div>
                <label for="textColorPicker">Cor do Texto:</label>
                <input type="color" id="textColorPicker" value="#cbd5e1">
                <label for="bgColorPicker">Cor do Fundo:</label>
                <input type="color" id="bgColorPicker" value="#1e222a">
                <div class="separator"></div>
                <select id="fontSizeSelect">
                    <option value="12px">12px</option>
                    <option value="14px" selected>14px</option>
                    <option value="16px">16px</option>
                </select>
                <select id="fontFamilySelect">
                    <option value="Arial" selected>Arial</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Courier New">Courier New</option>
                </select>
                <div class="separator"></div>
                <button class="modal-button" id="toggleWrapTextBtn"><i class="fas fa-text-width"></i> Quebra de Linha</button>
                <div class="separator"></div>
                <label for="cellTypeSelect" style="margin-right: 5px;">Tipo de Célula (Célula Ativa):</label>
                <select id="cellTypeSelect" onchange="applyCellType(this.value)">
                    <option value="text">Texto (String)</option>
                    <option value="number">Número</option>
                    <option value="date">Data</option>
                    <option value="time">Hora</option>
                    <option value="checkbox">Checkbox (Lista)</option>
                    <option value="link">Link</option>
                </select>
            </div>

            <div class="modal-sheet-layout">
                <div class="modal-sheet-main">
                    <div class="sheet-table-container">
                        <table class="sheet-table" id="dataTable">
                            <thead>
                                <tr id="columnHeaders">
                                    <th style="width: 150px;">Nome
                                        <button class="remove-col-button" onclick="removeColumn(event, this)"><i class="fas fa-times"></i></button>
                                        <div class="column-resizer"></div>
                                        <div class="column-edit-popover" data-column-index="0">
                                            <label for="colName_0">Nome da Coluna</label>
                                            <input type="text" id="colName_0" value="Nome">
                                            <label for="colType_0">Tipo</label>
                                            <select id="colType_0">
                                                <option value="text">Texto (String)</option>
                                                <option value="number">Número</option>
                                                <option value="date">Data</option>
                                                <option value="time">Hora</option>
                                                <option value="checkbox">Checkbox (Lista)</option>
                                                <option value="link">Link</option>
                                            </select>
                                            <label for="colWidth_0">Largura (px)</label>
                                            <input type="number" id="colWidth_0" value="150">
                                            <label style="display: flex; align-items: center; gap: 5px;">
                                                <input type="checkbox" id="colRequired_0"> Obrigatório
                                            </label>
                                            <div class="popover-actions">
                                                <button class="modal-button primary" onclick="saveColumnProperties(this)">Salvar</button>
                                                <button class="modal-button text-only" onclick="closeColumnPopover(this)">Cancelar</button>
                                            </div>
                                        </div>
                                    </th>
                                    <th style="width: 120px;">Data
                                        <button class="remove-col-button" onclick="removeColumn(event, this)"><i class="fas fa-times"></i></button>
                                        <div class="column-resizer"></div>
                                        <div class="column-edit-popover" data-column-index="1">
                                            <label for="colName_1">Nome da Coluna</label>
                                            <input type="text" id="colName_1" value="Data">
                                            <label for="colType_1">Tipo</label>
                                            <select id="colType_1">
                                                <option value="text">Texto (String)</option>
                                                <option value="number">Número</option>
                                                <option value="date" selected>Data</option>
                                                <option value="time">Hora</option>
                                                <option value="checkbox">Checkbox (Lista)</option>
                                                <option value="link">Link</option>
                                            </select>
                                            <label for="colWidth_1">Largura (px)</label>
                                            <input type="number" id="colWidth_1" value="120">
                                            <label style="display: flex; align-items: center; gap: 5px;">
                                                <input type="checkbox" id="colRequired_1"> Obrigatório
                                            </label>
                                            <div class="popover-actions">
                                                <button class="modal-button primary" onclick="saveColumnProperties(this)">Salvar</button>
                                                <button class="modal-button text-only" onclick="closeColumnPopover(this)">Cancelar</button>
                                            </div>
                                        </div>
                                    </th>
                                    </tr>
                            </thead>
                            <tbody>
                                <tr style="height: 38px;">
                                    <td><input type="text" value="Tarefa A" data-col-type="text"> <div class="row-resizer"></div></td>
                                    <td><input type="date" value="2025-05-23" data-col-type="date"> <div class="row-resizer"></div></td>
                                    <button class="remove-row-button" onclick="removeRow(this)"><i class="fas fa-times"></i></button>
                                </tr>
                                <tr style="height: 38px;">
                                    <td><input type="text" value="Tarefa B" data-col-type="text"> <div class="row-resizer"></div></td>
                                    <td><input type="date" value="2025-05-24" data-col-type="date"> <div class="row-resizer"></div></td>
                                    <button class="remove-row-button" onclick="removeRow(this)"><i class="fas fa-times"></i></button>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end;">
                        <button class="modal-button" onclick="resetTableSizes()">
                            <i class="fas fa-redo"></i> Redefinir Tamanhos
                        </button>
                        <button class="modal-button primary" onclick="addColumn()">
                            <i class="fas fa-plus"></i> Adicionar Coluna
                        </button>
                        <button class="modal-button primary" onclick="addRow()">
                            <i class="fas fa-plus"></i> Adicionar Linha
                        </button>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4 class="section-title"><i class="fas fa-file-import"></i> Importar Markdown</h4>
                        <textarea placeholder="Cole a tabela Markdown aqui..." style="margin-bottom: 10px;"></textarea>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <button class="modal-button primary">Importar</button>
                            <span class="tooltip-container">
                                <button class="modal-button"><i class="fas fa-question-circle"></i> ?</button>
                                <span class="tooltip-text">Use Markdown para importar tabelas</span>
                            </span>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4 class="section-title"><i class="fas fa-paperclip"></i> Anexos</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            <button class="modal-button">
                                <i class="fas fa-plus"></i> Adicionar Anexo
                            </button>
                            <div class="modal-button" style="background-color: #3f4757;"><i class="fas fa-file-alt"></i> Relatório.pdf</div>
                            <div class="modal-button" style="background-color: #3f4757;"><i class="fas fa-image"></i> Imagem.png</div>
                        </div>
                    </div>

                </div>

                <div class="modal-sidebar">
                    <h4 class="section-title">Ações</h4>
                    <button class="modal-button"><i class="fas fa-copy"></i> Copiar Planilha</button>
                    <button class="modal-button"><i class="fas fa-box"></i> Arquivar Planilha</button>
                    <button class="modal-button"><i class="fas fa-share-alt"></i> Compartilhar</button>
                    <button class="modal-button danger" style="margin-top: 20px;">
                        <i class="fas fa-trash-alt"></i> Excluir Planilha
                    </button>
                </div>
            </div>

            <div class="bottom-actions">
                <button class="modal-button primary">Salvar Tudo</button>
                <button class="modal-button text-only">Cancelar</button>
                <button class="modal-button">Ajuda para Planilha</button>
            </div>
        </div>
    </div>

    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item has-submenu">
            <i class="fas fa-exchange-alt"></i> Alterar Tipo de Célula
            <div class="context-menu-submenu">
                <div class="context-menu-item" data-type="text">Texto (String)</div>
                <div class="context-menu-item" data-type="number">Número</div>
                <div class="context-menu-item" data-type="date">Data</div>
                <div class="context-menu-item" data-type="time">Hora</div>
                <div class="context-menu-item" data-type="checkbox">Checkbox (Lista)</div>
                <div class="context-menu-item" data-type="link">Link</div>
            </div>
        </div>
        <div class="context-menu-item disabled"><i class="fas fa-copy"></i> Copiar</div>
        <div class="context-menu-item disabled"><i class="fas fa-paste"></i> Colar</div>
        <div class="context-menu-item disabled"><i class="fas fa-cut"></i> Recortar</div>
    </div>

    <script>
        let activeCell = null; // Para controlar a célula ativa na planilha
        let selectedCells = []; // Para armazenar múltiplas células selecionadas
        let isSelecting = false; // Flag para arrastar seleção
        let startCell = null; // Célula de início da seleção

        const DEFAULT_COL_WIDTH = 150; // Largura padrão para novas colunas
        const DEFAULT_ROW_HEIGHT = 38; // Altura padrão para novas linhas

        // --- Funções de Controle do Modal ---
        function openSheetModal() {
            document.getElementById('sheetModal').style.display = 'flex';
            // Adiciona listener para fechar popover ao clicar fora
            document.addEventListener('click', closeAllColumnPopovers);
            document.addEventListener('contextmenu', closeContextMenu); // Fechar menu de contexto ao clicar
            // Adiciona listeners para redimensionamento
            setupResizers();
            // Adiciona listeners para foco/desfoque em todas as células existentes
            setupCellInteractions();
        }

        function closeSheetModal() {
            document.getElementById('sheetModal').style.display = 'none';
            // Remove listeners
            document.removeEventListener('click', closeAllColumnPopovers);
            document.removeEventListener('contextmenu', closeContextMenu);
            document.removeEventListener('mousemove', resizeHandler);
            document.removeEventListener('mouseup', stopResizing);
            // Certifica-se de que a seleção e o foco sejam limpos
            clearSelection();
            if (activeCell) {
                if (activeCell.parentNode) activeCell.parentNode.classList.remove('active');
                activeCell.classList.remove('active');
                activeCell = null;
            }
        }

        // Fechar modal ao clicar no overlay
        window.onclick = function(event) {
            if (event.target == document.getElementById('sheetModal')) {
                closeSheetModal();
            }
        }

        // --- Maximizar/Restaurar Modal ---
        function toggleMaximizeModal() {
            const modalContent = document.querySelector('.modal-content');
            const maximizeBtnIcon = document.querySelector('.modal-maximize-button i');

            modalContent.classList.toggle('maximized');

            if (modalContent.classList.contains('maximized')) {
                maximizeBtnIcon.classList.remove('fa-window-maximize');
                maximizeBtnIcon.classList.add('fa-window-restore');
            } else {
                maximizeBtnIcon.classList.remove('fa-window-restore');
                maximizeBtnIcon.classList.add('fa-window-maximize');
            }
        }


        // --- Funções da Barra de Ferramentas (Formatação) ---
        // Funções para aplicar estilos ao texto da célula ativa ou selecionadas
        document.getElementById('boldBtn').addEventListener('click', () => toggleStyle('fontWeight', 'bold', 'normal'));
        document.getElementById('italicBtn').addEventListener('click', () => toggleStyle('fontStyle', 'italic', 'normal'));
        document.getElementById('underlineBtn').addEventListener('click', () => toggleStyle('textDecoration', 'underline', 'none'));
        document.getElementById('alignLeftBtn').addEventListener('click', () => applyStyle('textAlign', 'left'));
        document.getElementById('alignCenterBtn').addEventListener('click', () => applyStyle('textAlign', 'center'));
        document.getElementById('alignRightBtn').addEventListener('click', () => applyStyle('textAlign', 'right'));
        document.getElementById('fontSizeSelect').addEventListener('change', (e) => applyStyle('fontSize', e.target.value));
        document.getElementById('fontFamilySelect').addEventListener('change', (e) => applyStyle('fontFamily', e.target.value));
        document.getElementById('textColorPicker').addEventListener('input', (e) => applyStyle('color', e.target.value));
        document.getElementById('bgColorPicker').addEventListener('input', (e) => applyStyle('backgroundColor', e.target.value));
        document.getElementById('toggleWrapTextBtn').addEventListener('click', () => toggleWrapText());

        function applyStyle(property, value) {
            const targets = activeCell ? [activeCell] : (selectedCells.length > 0 ? selectedCells : []);

            targets.forEach(cellElement => {
                if (cellElement.tagName === 'INPUT' || cellElement.tagName === 'SELECT') {
                    cellElement.style[property] = value;
                } else if (cellElement.classList.contains('cell-content')) {
                    cellElement.style[property] = value;
                }
            });
        }

        function toggleStyle(property, valueOn, valueOff) {
            const targets = activeCell ? [activeCell] : (selectedCells.length > 0 ? selectedCells : []);

            targets.forEach(cellElement => {
                const currentValue = cellElement.style[property];
                applyStyle(property, currentValue === valueOn ? valueOff : valueOn);
            });
        }

        function toggleWrapText() {
            const targets = activeCell ? [activeCell] : (selectedCells.length > 0 ? selectedCells : []);

            targets.forEach(cellElement => {
                const parentTd = cellElement.closest('td');
                if (parentTd) {
                    // Alterna a classe no TD pai para controlar a quebra de linha
                    parentTd.classList.toggle('wrap-text');
                }
            });
        }


        // Função para mudar o tipo da CÉLULA ATIVA (não selecionadas)
        function applyCellType(type, targetCellElement = null) {
            const cellToChange = targetCellElement || activeCell;
            if (!cellToChange) return;

            const parentTd = cellToChange.closest('td');
            if (!parentTd) return;

            const currentStyles = cellToChange.style.cssText; // Mantém estilos atuais
            let oldValue = '';
            if (cellToChange.tagName === 'INPUT') oldValue = cellToChange.value;
            else if (cellToChange.tagName === 'SELECT') oldValue = cellToChange.value;
            else if (cellToChange.classList.contains('cell-content') && cellToChange.querySelector('input[type="checkbox"]')) {
                oldValue = cellToChange.querySelector('input[type="checkbox"]').checked;
            } else if (cellToChange.tagName === 'A') oldValue = cellToChange.href; // Para links

            // Remove o conteúdo existente para substituí-lo
            while (parentTd.firstChild) {
                parentTd.removeChild(parentTd.firstChild);
            }

            let newElement;
            if (type === 'date') {
                newElement = document.createElement('input');
                newElement.type = 'date';
                newElement.value = oldValue;
            } else if (type === 'number') {
                newElement = document.createElement('input');
                newElement.type = 'number';
                newElement.value = parseFloat(oldValue) || 0;
            } else if (type === 'time') {
                newElement = document.createElement('input');
                newElement.type = 'time';
                newElement.value = oldValue;
            } else if (type === 'checkbox') {
                newElement = document.createElement('input');
                newElement.type = 'checkbox';
                newElement.checked = (oldValue === true || oldValue === 'true');
                // Para checkboxes, precisamos de um wrapper para os estilos de fundo/texto
                const wrapper = document.createElement('div');
                wrapper.classList.add('cell-content');
                wrapper.appendChild(newElement);
                parentTd.appendChild(wrapper);
                cellToChange.style.width = 'auto'; // Não estica o checkbox
                cellToChange.style.height = 'auto';
                cellToChange.style.padding = '0';
                newElement = wrapper; // O wrapper se torna a referência
            } else if (type === 'link') {
                newElement = document.createElement('input'); // Começa como input de texto para edição
                newElement.type = 'text';
                newElement.placeholder = 'Digite um link...';
                newElement.value = oldValue;
                newElement.addEventListener('dblclick', () => { // Simplesmente abre o link (sem validação)
                    if (newElement.value.startsWith('http')) window.open(newElement.value, '_blank');
                });
            } else { // text (default)
                newElement = document.createElement('input');
                newElement.type = 'text';
                newElement.value = oldValue;
            }

            if (type !== 'checkbox') {
                parentTd.appendChild(newElement);
            }
            // Restaura os estilos e o estado ativo
            newElement.style.cssText = currentStyles;
            newElement.setAttribute('data-col-type', type);

            // Atualiza a referência de activeCell se for a célula que estava ativa
            if (cellToChange === activeCell) {
                activeCell = newElement;
                activeCell.parentNode.classList.add('active'); // Garante que o TD pai continue ativo
                activeCell.classList.add('active'); // Garante que o novo elemento continue ativo
            }
            
            // Re-adiciona listeners para o novo elemento
            setupCellInteractionsForElement(newElement);
            if (cellToChange === activeCell) {
                activeCell.focus(); // Coloca o foco no novo input/wrapper
            }
        }


        // --- Controle de Células Ativas e Selecionadas ---
        function setupCellInteractions() {
            document.querySelectorAll('#dataTable td').forEach(td => {
                td.removeEventListener('mousedown', startCellSelection);
                td.removeEventListener('contextmenu', showContextMenu);

                td.addEventListener('mousedown', startCellSelection);
                td.addEventListener('contextmenu', showContextMenu);

                // Garante que os elementos internos (inputs, etc.) também tenham listeners de foco/blur
                const innerElement = td.querySelector('input, select, .cell-content');
                if (innerElement) {
                    innerElement.removeEventListener('focus', cellFocusHandler);
                    innerElement.removeEventListener('blur', cellBlurHandler);
                    innerElement.addEventListener('focus', cellFocusHandler);
                    innerElement.addEventListener('blur', cellBlurHandler);
                }
            });
        }

        function setupCellInteractionsForElement(element) {
            element.removeEventListener('focus', cellFocusHandler);
            element.removeEventListener('blur', cellBlurHandler);
            element.addEventListener('focus', cellFocusHandler);
            element.addEventListener('blur', cellBlurHandler);
        }

        function cellFocusHandler(event) {
            // Se já estiver selecionando, não mude o activeCell imediatamente
            if (isSelecting) return;

            // Remove destaque da célula anterior
            if (activeCell) {
                if (activeCell.parentNode) activeCell.parentNode.classList.remove('active');
                activeCell.classList.remove('active');
            }
            activeCell = event.target;
            activeCell.parentNode.classList.add('active'); // Destaca o TD pai
            activeCell.classList.add('active'); // Destaca o input/select/wrapper

            // Limpa seleção se o foco mudar para uma célula não selecionada
            if (!selectedCells.includes(activeCell.closest('td').querySelector('input, select, .cell-content'))) {
                 clearSelection();
            }

            // Atualiza a barra de ferramentas com os estilos da célula ativa
            updateToolbarFromActiveCell();
        }

        function cellBlurHandler(event) {
            // Pequeno delay para permitir cliques em outros elementos da barra de ferramentas
            setTimeout(() => {
                const relatedTarget = event.relatedTarget;
                const toolbar = document.querySelector('.sheet-toolbar');
                const popover = document.querySelector('.column-edit-popover');
                const contextMenu = document.getElementById('contextMenu');

                if (!relatedTarget || (
                    !toolbar.contains(relatedTarget) &&
                    !popover.contains(relatedTarget) &&
                    !relatedTarget.closest('.column-edit-popover') &&
                    !contextMenu.contains(relatedTarget) // Não desativa se o foco for para o menu de contexto
                )) {
                    // Não limpa o activeCell se a seleção ainda estiver ativa (clicando em outra célula selecionada)
                    // Mas remove o destaque da célula individual se não for mais o foco
                    if (activeCell && !selectedCells.includes(activeCell.closest('td').querySelector('input, select, .cell-content'))) {
                        if (activeCell.parentNode) activeCell.parentNode.classList.remove('active');
                        activeCell.classList.remove('active');
                        activeCell = null;
                    } else if (activeCell && selectedCells.includes(activeCell.closest('td').querySelector('input, select, .cell-content'))) {
                        // Se o activeCell ainda está na seleção mas perdeu o foco, remove apenas o destaque de foco
                        activeCell.classList.remove('active');
                        if (activeCell.parentNode) activeCell.parentNode.classList.remove('active');
                    }
                }
            }, 50);
        }

        function updateToolbarFromActiveCell() {
            if (activeCell) {
                document.getElementById('boldBtn').style.fontWeight = activeCell.style.fontWeight;
                document.getElementById('italicBtn').style.fontStyle = activeCell.style.fontStyle;
                document.getElementById('underlineBtn').style.textDecoration = activeCell.style.textDecoration;
                document.getElementById('fontSizeSelect').value = activeCell.style.fontSize || '14px';
                document.getElementById('fontFamilySelect').value = activeCell.style.fontFamily || 'Arial';
                document.getElementById('textColorPicker').value = rgbToHex(activeCell.style.color || window.getComputedStyle(activeCell).color);
                document.getElementById('bgColorPicker').value = rgbToHex(activeCell.style.backgroundColor || window.getComputedStyle(activeCell).backgroundColor);
                document.getElementById('cellTypeSelect').value = activeCell.getAttribute('data-col-type') || 'text';
                
                const parentTd = activeCell.closest('td');
                if (parentTd) {
                    if (parentTd.classList.contains('wrap-text')) {
                        document.getElementById('toggleWrapTextBtn').classList.add('primary');
                    } else {
                        document.getElementById('toggleWrapTextBtn').classList.remove('primary');
                    }
                }
            }
        }


        // Função auxiliar para converter RGB para Hex (para color pickers)
        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb; // Já é Hex
            if (rgb === 'rgba(0, 0, 0, 0)') return '#000000'; // Transparente, assume preto
            if (rgb === 'transparent') return '#000000'; // Transparente, assume preto

            const a = rgb.match(/\d+/g); // Extrai os números (R, G, B)
            if (!a || a.length < 3) return '#000000'; // Erro na conversão, retorna preto

            return "#" + (
                "0" + parseInt(a[0]).toString(16)
            ).slice(-2) + (
                "0" + parseInt(a[1]).toString(16)
            ).slice(-2) + (
                "0" + parseInt(a[2]).toString(16)
            ).slice(-2);
        }

        // --- Seleção de Células (Drag-and-Drop) ---
        function getCellFromEvent(event) {
            const target = event.target.closest('td');
            if (target) {
                // Retorna o elemento de input/select/div que está dentro do TD
                return target.querySelector('input, select, .cell-content');
            }
            return null;
        }

        function startCellSelection(e) {
            // Não inicie a seleção se for um clique com o botão direito
            if (e.button === 2) return;

            const targetCellElement = getCellFromEvent(e);
            if (!targetCellElement) return;

            isSelecting = true;
            startCell = targetCellElement;

            clearSelection(); // Limpa seleções anteriores
            selectedCells.push(startCell);
            startCell.closest('td').classList.add('selected');

            // Define a célula inicial como ativa
            if (activeCell) {
                if (activeCell.parentNode) activeCell.parentNode.classList.remove('active');
                activeCell.classList.remove('active');
            }
            activeCell = startCell;
            activeCell.parentNode.classList.add('active');
            activeCell.classList.add('active');
            updateToolbarFromActiveCell();


            document.addEventListener('mousemove', continueCellSelection);
            document.addEventListener('mouseup', endCellSelection);
        }

        function continueCellSelection(e) {
            if (!isSelecting) return;

            const currentCellElement = getCellFromEvent(e);
            if (!currentCellElement || currentCellElement === activeCell) return; // Evita reprocessar a mesma célula ou a ativa

            // Limpa a seleção visual atual antes de recalcular
            clearSelection();
            selectedCells = [];

            const table = document.getElementById('dataTable');
            const startRow = startCell.closest('tr').rowIndex;
            const startCol = Array.from(startCell.closest('td').parentNode.children).indexOf(startCell.closest('td'));
            const endRow = currentCellElement.closest('tr').rowIndex;
            const endCol = Array.from(currentCellElement.closest('td').parentNode.children).indexOf(currentCellElement.closest('td'));

            const minRow = Math.min(startRow, endRow);
            const maxRow = Math.max(startRow, endRow);
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);

            for (let r = minRow; r <= maxRow; r++) {
                const row = table.rows[r];
                if (row) {
                    for (let c = minCol; c <= maxCol; c++) {
                        const cell = row.cells[c];
                        if (cell) {
                            cell.classList.add('selected');
                            const innerElement = cell.querySelector('input, select, .cell-content');
                            if (innerElement && !selectedCells.includes(innerElement)) {
                                selectedCells.push(innerElement);
                            }
                        }
                    }
                }
            }
        }

        function endCellSelection() {
            isSelecting = false;
            startCell = null;
            document.removeEventListener('mousemove', continueCellSelection);
            document.removeEventListener('mouseup', endCellSelection);
            // O activeCell já está definido no startCellSelection
            // A barra de ferramentas já foi atualizada no startCellSelection
        }

        function clearSelection() {
            selectedCells.forEach(cellElement => {
                const parentTd = cellElement.closest('td');
                if (parentTd) {
                    parentTd.classList.remove('selected');
                }
            });
            selectedCells = [];
        }

        // --- Funções de Gerenciamento de Colunas e Linhas ---

        function addColumn() {
            const dataTable = document.getElementById('dataTable');
            const headerRow = dataTable.querySelector('thead tr');
            const tbody = dataTable.querySelector('tbody');
            const colIndex = headerRow.cells.length; // Novo índice da coluna

            // Adiciona o cabeçalho da nova coluna
            const newTh = document.createElement('th');
            newTh.style.width = DEFAULT_COL_WIDTH + 'px'; // Largura padrão
            newTh.textContent = 'Nova Coluna';
            // Adiciona botão de remover coluna
            newTh.innerHTML += ` <button class="remove-col-button" onclick="removeColumn(event, this)"><i class="fas fa-times"></i></button>`;
            // Adiciona resizer de coluna
            newTh.innerHTML += `<div class="column-resizer"></div>`;

            // Adiciona popover de edição
            const popover = document.createElement('div');
            popover.classList.add('column-edit-popover');
            popover.setAttribute('data-column-index', colIndex);
            popover.innerHTML = `
                <label for="colName_${colIndex}">Nome da Coluna</label>
                <input type="text" id="colName_${colIndex}" value="Nova Coluna">
                <label for="colType_${colIndex}">Tipo</label>
                <select id="colType_${colIndex}">
                    <option value="text">Texto (String)</option>
                    <option value="number">Número</option>
                    <option value="date">Data</option>
                    <option value="time">Hora</option>
                    <option value="checkbox">Checkbox (Lista)</option>
                    <option value="link">Link</option>
                </select>
                <label for="colWidth_${colIndex}">Largura (px)</label>
                <input type="number" id="colWidth_${colIndex}" value="${DEFAULT_COL_WIDTH}">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="colRequired_${colIndex}"> Obrigatório
                </label>
                <div class="popover-actions">
                    <button class="modal-button primary" onclick="saveColumnProperties(this)">Salvar</button>
                    <button class="modal-button text-only" onclick="closeColumnPopover(this)">Cancelar</button>
                </div>
            `;
            newTh.appendChild(popover);
            headerRow.appendChild(newTh);
            
            // Re-setup listeners para o novo TH e resizer
            newTh.addEventListener('click', (e) => toggleColumnPopover(e, newTh));
            setupResizersForElement(newTh.querySelector('.column-resizer'));


            // Adiciona célula para cada linha existente no tbody
            Array.from(tbody.rows).forEach(row => {
                const newTd = row.insertCell();
                const newInput = document.createElement('input');
                newInput.type = 'text';
                newInput.value = '';
                newInput.setAttribute('data-col-type', 'text'); // Tipo padrão
                newTd.appendChild(newInput);
                newTd.innerHTML += `<div class="row-resizer"></div>`; // Adiciona resizer de linha
                setupResizersForElement(newTd.querySelector('.row-resizer'));
            });

            setupCellInteractions(); // Atualiza listeners de foco e seleção
        }

        function removeColumn(event, button) {
            event.stopPropagation(); // Evita que o popover abra/feche
            const th = button.closest('th');
            const columnIndex = Array.from(th.parentNode.children).indexOf(th);

            // Confirmação com o nome real da coluna
            let columnName = '';
            const popover = th.querySelector('.column-edit-popover');
            if (popover) {
                 columnName = popover.querySelector(`input[id="colName_${columnIndex}"]`).value;
            } else {
                // Fallback para o texto do cabeçalho se o popover não for encontrado (apenas para o caso de colunas sem popover)
                for (let node of th.childNodes) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        columnName = node.nodeValue.trim();
                        break;
                    }
                }
            }


            if (confirm(`Tem certeza que deseja remover a coluna "${columnName}"?`)) {
                const dataTable = document.getElementById('dataTable');
                const headerRow = dataTable.querySelector('thead tr');
                const tbody = dataTable.querySelector('tbody');

                // Remove o cabeçalho
                headerRow.removeChild(th);

                // Remove a célula correspondente de cada linha
                Array.from(tbody.rows).forEach(row => {
                    if (row.cells[columnIndex]) {
                        row.deleteCell(columnIndex);
                    }
                });
                setupCellInteractions(); // Atualiza listeners após remoção
            }
        }

        function addRow() {
            const tbody = document.getElementById('dataTable').querySelector('tbody');
            const headerRow = document.getElementById('dataTable').querySelector('thead tr');
            const numColumns = headerRow.cells.length;

            const newRow = tbody.insertRow();
            newRow.style.height = DEFAULT_ROW_HEIGHT + 'px'; // Altura padrão

            for (let i = 0; i < numColumns; i++) {
                const newTd = newRow.insertCell();
                // Obtém o tipo de célula da coluna correspondente (do popover)
                const popover = headerRow.cells[i].querySelector('.column-edit-popover');
                const colType = popover ? popover.querySelector(`select[id^="colType"]`).value : 'text';

                let cellElement;
                if (colType === 'date') {
                    cellElement = document.createElement('input');
                    cellElement.type = 'date';
                } else if (colType === 'number') {
                    cellElement = document.createElement('input');
                    cellElement.type = 'number';
                    cellElement.value = 0;
                } else if (colType === 'time') {
                    cellElement = document.createElement('input');
                    cellElement.type = 'time';
                } else if (colType === 'checkbox') {
                    cellElement = document.createElement('input');
                    cellElement.type = 'checkbox';
                    const wrapper = document.createElement('div');
                    wrapper.classList.add('cell-content');
                    wrapper.appendChild(cellElement);
                    newTd.appendChild(wrapper); // Adiciona o wrapper em vez do input direto
                    cellElement.style.width = 'auto'; // Ajusta estilos do checkbox
                    cellElement.style.height = 'auto';
                    cellElement.style.padding = '0';
                } else if (colType === 'link') {
                    cellElement = document.createElement('input');
                    cellElement.type = 'text';
                    cellElement.placeholder = 'link...';
                } else { // text
                    cellElement = document.createElement('input');
                    cellElement.type = 'text';
                }

                if (colType !== 'checkbox') {
                    newTd.appendChild(cellElement);
                }
                cellElement.setAttribute('data-col-type', colType);
                newTd.innerHTML += `<div class="row-resizer"></div>`; // Adiciona resizer de linha
                setupResizersForElement(newTd.querySelector('.row-resizer'));
            }
            // Adiciona o botão de remover linha
            const removeRowBtn = document.createElement('button');
            removeRowBtn.classList.add('remove-row-button');
            removeRowBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeRowBtn.onclick = function() { removeRow(this); };
            newRow.appendChild(removeRowBtn);

            setupCellInteractions(); // Atualiza listeners de foco e seleção
        }

        function removeRow(button) {
            if (confirm('Tem certeza que deseja remover esta linha?')) {
                const row = button.closest('tr');
                row.parentNode.removeChild(row);
                setupCellInteractions(); // Atualiza listeners após remoção
            }
        }

        // --- Funções do Popover de Coluna ---
        let activeColumnPopover = null;

        function toggleColumnPopover(event, headerCell) {
            // Verifica se o clique foi no resizer ou no botão de remover, para não abrir o popover
            if (event.target.classList.contains('column-resizer') || event.target.closest('.remove-col-button')) {
                return;
            }

            event.stopPropagation(); // Evita que o clique feche o modal principal
            const popover = headerCell.querySelector('.column-edit-popover');

            if (activeColumnPopover && activeColumnPopover !== popover) {
                activeColumnPopover.style.display = 'none';
                activeColumnPopover.parentNode.classList.remove('active'); // Remove destaque do cabeçalho anterior
            }

            if (popover.style.display === 'flex') {
                popover.style.display = 'none';
                headerCell.classList.remove('active');
                activeColumnPopover = null;
            } else {
                // Preenche o popover com os dados atuais da coluna
                const colIndex = parseInt(popover.getAttribute('data-column-index'));
                const colNameInput = popover.querySelector(`input[id="colName_${colIndex}"]`);
                const colTypeSelect = popover.querySelector(`select[id="colType_${colIndex}"]`);
                const colWidthInput = popover.querySelector(`input[id="colWidth_${colIndex}"]`);
                // const colRequiredCheckbox = popover.querySelector(`input[id="colRequired_${colIndex}"]`); // Não usado por enquanto

                // O texto do cabeçalho pode ter o botão 'X' ou o resizer, pegamos o node de texto
                let currentHeaderText = '';
                for (let node of headerCell.childNodes) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        currentHeaderText = node.nodeValue.trim();
                        break;
                    }
                }
                colNameInput.value = currentHeaderText;
                colTypeSelect.value = getColumnTypeFromCells(colIndex); // Pega o tipo real das células
                colWidthInput.value = parseInt(headerCell.style.width) || DEFAULT_COL_WIDTH;

                popover.style.display = 'flex';
                headerCell.classList.add('active');
                activeColumnPopover = popover;
            }
        }

        function closeColumnPopover(button) {
            const popover = button.closest('.column-edit-popover');
            popover.style.display = 'none';
            popover.parentNode.classList.remove('active');
            activeColumnPopover = null;
        }

        function closeAllColumnPopovers(event) {
            // Não fecha se o clique foi dentro de um popover ou no cabeçalho de coluna
            if (activeColumnPopover && !activeColumnPopover.contains(event.target) && !event.target.closest('th')) {
                activeColumnPopover.style.display = 'none';
                activeColumnPopover.parentNode.classList.remove('active');
                activeColumnPopover = null;
            }
        }

        function saveColumnProperties(button) {
            const popover = button.closest('.column-edit-popover');
            const headerCell = popover.parentNode;
            const colIndex = parseInt(popover.getAttribute('data-column-index'));

            const newName = popover.querySelector(`input[id="colName_${colIndex}"]`).value;
            const newType = popover.querySelector(`select[id="colType_${colIndex}"]`).value;
            const newWidth = popover.querySelector(`input[id="colWidth_${colIndex}"]`).value;
            const isRequired = popover.querySelector(`input[id="colRequired_${colIndex}"]`).checked; // Apenas valor, sem lógica

            // Atualiza o texto do cabeçalho
            let headerTextNode = null;
            for (let node of headerCell.childNodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    headerTextNode = node;
                    break;
                }
            }
            if (headerTextNode) {
                headerTextNode.nodeValue = newName;
            } else {
                headerCell.insertBefore(document.createTextNode(newName), headerCell.firstChild);
            }
            headerCell.style.width = newWidth + 'px';

            // Atualiza o tipo das células na coluna correspondente
            const tbody = document.getElementById('dataTable').querySelector('tbody');
            Array.from(tbody.rows).forEach(row => {
                const cell = row.cells[colIndex];
                if (cell) {
                    const currentElement = cell.querySelector('input, select, .cell-content');
                    // Guarda estilos atuais e valor
                    const currentStyles = currentElement ? currentElement.style.cssText : '';
                    let oldValue = '';
                    if (currentElement) {
                        if (currentElement.tagName === 'INPUT') oldValue = currentElement.value;
                        else if (currentElement.tagName === 'SELECT') oldValue = currentElement.value;
                        else if (currentElement.classList.contains('cell-content') && currentElement.querySelector('input[type="checkbox"]')) {
                            oldValue = currentElement.querySelector('input[type="checkbox"]').checked;
                        } else if (currentElement.tagName === 'A') oldValue = currentElement.href;
                    }

                    // Remove conteúdo antigo
                    while (cell.firstChild) {
                        cell.removeChild(cell.firstChild);
                    }

                    // Cria novo elemento de célula baseado no tipo
                    let newCellElement;
                    if (newType === 'date') {
                        newCellElement = document.createElement('input');
                        newCellElement.type = 'date';
                        newCellElement.value = oldValue;
                    } else if (newType === 'number') {
                        newCellElement = document.createElement('input');
                        newCellElement.type = 'number';
                        newCellElement.value = parseFloat(oldValue) || 0;
                    } else if (newType === 'time') {
                        newCellElement = document.createElement('input');
                        newCellElement.type = 'time';
                        newCellElement.value = oldValue;
                    } else if (newType === 'checkbox') {
                        newCellElement = document.createElement('input');
                        newCellElement.type = 'checkbox';
                        newCellElement.checked = (oldValue === true || oldValue === 'true');
                        // Wrapper para checkbox
                        const wrapper = document.createElement('div');
                        wrapper.classList.add('cell-content');
                        wrapper.appendChild(newCellElement);
                        cell.appendChild(wrapper);
                        newCellElement.style.width = 'auto';
                        newCellElement.style.height = 'auto';
                        newCellElement.style.padding = '0';
                        newCellElement = wrapper; // O wrapper é o elemento "ativo" para estilos
                    } else if (newType === 'link') {
                        newCellElement = document.createElement('input');
                        newCellElement.type = 'text';
                        newCellElement.placeholder = 'link...';
                        newCellElement.value = oldValue;
                        newCellElement.addEventListener('dblclick', () => {
                            if (newCellElement.value.startsWith('http')) window.open(newCellElement.value, '_blank');
                        });
                    } else { // text
                        newCellElement = document.createElement('input');
                        newCellElement.type = 'text';
                        newCellElement.value = oldValue;
                    }

                    if (newType !== 'checkbox') {
                        cell.appendChild(newCellElement);
                    }

                    newCellElement.style.cssText = currentStyles; // Restaura estilos
                    newCellElement.setAttribute('data-col-type', newType);
                }
            });

            closeColumnPopover(button);
            setupCellInteractions(); // Re-adiciona listeners para os novos elementos
        }

        // Função auxiliar para determinar o tipo de uma coluna lendo as células
        function getColumnTypeFromCells(columnIndex) {
            const tbody = document.getElementById('dataTable').querySelector('tbody');
            if (tbody.rows.length === 0) return 'text'; // Sem linhas, assume texto

            const firstCellInColumn = tbody.rows[0].cells[columnIndex];
            if (firstCellInColumn) {
                const element = firstCellInColumn.querySelector('input, select, .cell-content');
                if (element) {
                    return element.getAttribute('data-col-type') || 'text';
                }
            }
            return 'text';
        }

        // --- Redimensionamento de Colunas e Linhas ---
        let resizing = false;
        let resizerElement = null;
        let startX, startY, startWidth, startHeight;

        function setupResizers() {
            document.querySelectorAll('.column-resizer').forEach(resizer => {
                resizer.removeEventListener('mousedown', startColumnResize); // Evita duplicidade
                resizer.addEventListener('mousedown', startColumnResize);
            });
            document.querySelectorAll('.row-resizer').forEach(resizer => {
                resizer.removeEventListener('mousedown', startRowResize); // Evita duplicidade
                resizer.addEventListener('mousedown', startRowResize);
            });
        }

        function setupResizersForElement(element) {
            if (element.classList.contains('column-resizer')) {
                element.removeEventListener('mousedown', startColumnResize);
                element.addEventListener('mousedown', startColumnResize);
            } else if (element.classList.contains('row-resizer')) {
                element.removeEventListener('mousedown', startRowResize);
                element.addEventListener('mousedown', startRowResize);
            }
        }


        function startColumnResize(e) {
            resizing = true;
            resizerElement = e.target;
            const th = resizerElement.closest('th');
            startX = e.clientX;
            startWidth = th.offsetWidth;
            th.classList.add('resizing');
            resizerElement.classList.add('active'); // Destaca o resizer
            document.addEventListener('mousemove', resizeHandler);
            document.addEventListener('mouseup', stopResizing);
            e.preventDefault(); // Evita seleção de texto
        }

        function startRowResize(e) {
            resizing = true;
            resizerElement = e.target;
            const tr = resizerElement.closest('tr');
            startY = e.clientY;
            startHeight = tr.offsetHeight;
            tr.classList.add('resizing');
            resizerElement.classList.add('active'); // Destaca o resizer
            document.addEventListener('mousemove', resizeHandler);
            document.addEventListener('mouseup', stopResizing);
            e.preventDefault(); // Evita seleção de texto
        }

        function resizeHandler(e) {
            if (!resizing || !resizerElement) return;

            if (resizerElement.classList.contains('column-resizer')) {
                const th = resizerElement.closest('th');
                const newWidth = startWidth + (e.clientX - startX);
                th.style.width = Math.max(50, newWidth) + 'px'; // Largura mínima de 50px
            } else if (resizerElement.classList.contains('row-resizer')) {
                const tr = resizerElement.closest('tr');
                const newHeight = startHeight + (e.clientY - startY);
                tr.style.height = Math.max(25, newHeight) + 'px'; // Altura mínima de 25px
            }
        }

        function stopResizing() {
            resizing = false;
            if (resizerElement) {
                const parentElement = resizerElement.closest('th') || resizerElement.closest('tr');
                if (parentElement) {
                    parentElement.classList.remove('resizing');
                }
                resizerElement.classList.remove('active'); // Remove destaque do resizer
                resizerElement = null;
            }
            document.removeEventListener('mousemove', resizeHandler);
            document.removeEventListener('mouseup', stopResizing);
        }

        // --- Redefinir Tamanhos ---
        function resetTableSizes() {
            const dataTable = document.getElementById('dataTable');
            const headerCells = dataTable.querySelectorAll('thead th');
            const bodyRows = dataTable.querySelectorAll('tbody tr');

            headerCells.forEach(th => {
                th.style.width = DEFAULT_COL_WIDTH + 'px';
                // Reset do popover para o valor padrão
                const popover = th.querySelector('.column-edit-popover');
                if (popover) {
                    const colIndex = parseInt(popover.getAttribute('data-column-index'));
                    popover.querySelector(`input[id="colWidth_${colIndex}"]`).value = DEFAULT_COL_WIDTH;
                }
            });

            bodyRows.forEach(tr => {
                tr.style.height = DEFAULT_ROW_HEIGHT + 'px';
                // Remove a classe wrap-text para resetar o comportamento da quebra de linha
                Array.from(tr.cells).forEach(td => {
                    td.classList.remove('wrap-text');
                });
            });
            // Desativa o botão de quebra de linha na barra de ferramentas
            document.getElementById('toggleWrapTextBtn').classList.remove('primary');
        }

        // --- Menu de Contexto (Botão Direito) ---
        let contextMenuTargetCellElement = null; // A célula que ativou o menu de contexto

        function showContextMenu(e) {
            // Verifica se o clique foi na borda (resizer) para não abrir o menu
            if (e.target.classList.contains('column-resizer') || e.target.classList.contains('row-resizer') || e.target.closest('.remove-col-button') || e.target.closest('.remove-row-button')) {
                return;
            }

            e.preventDefault(); // Impede o menu de contexto padrão do navegador

            const contextMenu = document.getElementById('contextMenu');
            contextMenuTargetCellElement = getCellFromEvent(e); // Guarda a referência da célula clicada

            // Posiciona o menu
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.display = 'block';

            // Fecha o menu se clicar fora
            document.addEventListener('click', closeContextMenu);
            document.addEventListener('contextmenu', closeContextMenu);
        }

        function closeContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            document.removeEventListener('click', closeContextMenu);
            document.removeEventListener('contextmenu', closeContextMenu);
            contextMenuTargetCellElement = null; // Limpa a referência
        }

        // Adiciona listeners para os itens do menu de contexto
        document.querySelectorAll('#contextMenu .context-menu-item').forEach(item => {
            if (item.classList.contains('has-submenu')) {
                // Para itens com submenu, apenas o hover no pai mostra o submenu
                item.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita que o clique no pai feche o menu principal
                });
                item.querySelectorAll('.context-menu-submenu .context-menu-item').forEach(subItem => {
                    subItem.addEventListener('click', (e) => {
                        e.stopPropagation(); // Evita que o clique no subitem feche o submenu e o menu principal de uma vez
                        const type = subItem.getAttribute('data-type');
                        if (contextMenuTargetCellElement && type) {
                            applyCellType(type, contextMenuTargetCellElement);
                        }
                        closeContextMenu(); // Fecha o menu de contexto após a ação
                    });
                });
            } else {
                // Ações diretas do menu principal
                item.addEventListener('click', (e) => {
                    // Por enquanto, não há ações diretas além do submenu de tipo de célula
                    closeContextMenu();
                });
            }
        });

        // Inicializa listeners na carga da página para elementos que já existem
        document.addEventListener('DOMContentLoaded', () => {
            setupResizers();
            setupCellInteractions();
        });
    </script>
</body>
</html>